<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜•æ¾„ xincheng é ç´„å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-color: #f7f3ee; --accent-color: #8d775f; --text-color: #4a4a4a; }
        body { font-family: "PingFang TC", "Noto Sans TC", sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: var(--text-color); }
        
        /* è¨­å®šé¢æ¿ */
        .settings-panel { background: #fff; border-radius: 12px; width: 100%; max-width: 420px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-nav { display: flex; background: #f8f8f8; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: #888; cursor: pointer; font-size: 13px; }
        .tab-btn.active { color: var(--accent-color); background: #fff; border-bottom: 2px solid var(--accent-color); }
        .tab-content { display: none; padding: 15px; max-height: 420px; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .input-group { margin-bottom: 12px; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        input[type="color"] { width: 45px; height: 28px; border: 1px solid #ddd; cursor: pointer; }
        input[type="text"], input[type="number"], textarea, input[type="range"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        .color-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }

        /* é è¦½å€åŸŸ */
        .responsive-wrapper { width: 100%; display: flex; justify-content: center; }
        #capture-area { 
            width: 420px; min-height: 746.66px; 
            background-color: var(--bg-color); 
            padding: 45px 25px 40px 25px;
            display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
            overflow: hidden;
        }

        #bg-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; pointer-events: none; }
        .content-layer { position: relative; z-index: 2; width: 100%; height: 100%; display: flex; flex-direction: column; }

        #title-month { font-size: 24px; font-weight: bold; text-transform: uppercase; text-align: center; margin-bottom: 2px; }
        #display-studio-name { text-align: center; margin-bottom: 20px; letter-spacing: 4px; font-size: 14px; font-weight: bold; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; border-top: 1.5px solid rgba(0,0,0,0.1); padding-top: 15px; margin-bottom: 15px; }
        .weekday { font-size: 10px; font-weight: bold; padding-bottom: 8px; text-align: center; }
        .day-box { border-radius: 4px; background: rgba(255,255,255,0.4); display: flex; flex-direction: column; align-items: center; padding: 4px 1px; min-height: 65px; }
        .day-num { font-size: 12px; font-weight: bold; margin-bottom: 2px; }
        .slot { font-size: 9px; font-weight: bold; background: #fff; margin: 1px 0; padding: 3px 0; border-radius: 3px; width: 92%; text-align: center; border: 0.5px solid #eee; }
        .slot.booked { opacity: 0 !important; }

        /* åº•éƒ¨æ’ç‰ˆ */
        .footer-wrap { margin-top: auto; border-top: 1.2px solid rgba(0,0,0,0.1); padding-top: 15px; position: relative; width: 100%; min-height: 100px; }
        
        /* æ–‡å­—åœ–å±¤ï¼šè¨­å®šè¼ƒé«˜çš„ z-index ä¸¦ç¢ºä¿èƒŒæ™¯é€æ˜å¯çœ‹è¦‹ä¸‹æ–¹çš„ Logo */
        .footer-notice { 
            font-size: 11px; font-weight: bold; text-align: left; line-height: 1.7; white-space: pre-wrap; 
            width: 100%; position: relative; z-index: 10; 
        }
        
        /* Logo åœ–å±¤ï¼šz-index è¨­ç‚ºè¼ƒä½ï¼Œä½¿å…¶åœ¨æ–‡å­—ä¸‹æ–¹ */
        #display-qrcode { 
            position: absolute; 
            right: 0; 
            bottom: 0; 
            object-fit: contain; 
            display: none; 
            z-index: 5; 
            opacity: 0.8; /* ç¨å¾®å¢åŠ é€æ˜åº¦ï¼Œè®“ç–ŠåŠ æ™‚æ–‡å­—æ›´æ¸…æ™° */
        }
        .hl-text { font-weight: 900; }

        .btn-generate { width: 100%; max-width: 420px; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; margin: 10px 0 20px 0; cursor: pointer; }
        #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #preview-image { max-width: 90%; max-height: 80vh; border-radius: 10px; }
        .btn-close { margin-top: 15px; padding: 10px 40px; background: #fff; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="settings-panel">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab(event, 'tab-time')">ğŸ“… é ç´„æ™‚é–“</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-content')">âœï¸ å…§å®¹æ–‡å­—</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-style')">ğŸ¨ æ¨£å¼æ§åˆ¶</button>
        </div>

        <div id="tab-time" class="tab-content active">
            <div style="display:flex; gap:8px">
                <div class="input-group" style="flex:1"><label>å¹´ä»½</label><input type="number" id="inputYear" value="2026" oninput="validateAndUpdate()"></div>
                <div class="input-group" style="flex:1"><label>æœˆä»½</label><input type="number" id="inputMonth" value="2" oninput="validateAndUpdate()"></div>
            </div>
            <div class="input-group"><label>é–‹æ”¾æ™‚æ®µ</label><input type="text" id="timeSlots" value="15:00, 17:00, 19:00" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>æ’é™¤æ—¥æœŸæ™‚æ®µ</label><input type="text" id="excludeSlots" placeholder="2/5 17-19" oninput="validateAndUpdate()"></div>
        </div>

        <div id="tab-content" class="tab-content">
            <div class="input-group"><label>å·¥ä½œå®¤åç¨±</label><input type="text" id="inputStudioName" value="æ˜•æ¾„ xincheng" oninput="validateAndUpdate()"></div>
            <div class="input-group">
                <label>é ç´„é ˆçŸ¥ ([ ] åŒ…ä½é—œéµå­—å¯æ”¹è‰²)</label>
                <textarea id="inputNotice" oninput="validateAndUpdate()">âœ¨ é ç´„é ˆçŸ¥
â€¢ å·¥ä½œå®¤æ¡ä¸€å°ä¸€æœå‹™ï¼Œè«‹æå‰é ç´„ã€‚
â€¢ è®Šæ›´é ç´„è«‹æ–¼ã€Œ[24å°æ™‚å‰]ã€å‘ŠçŸ¥ã€‚
â€¢ [é²åˆ°è€…] æ–½åšæ™‚é–“å°‡ç„¡æ³•é †å»¶ã€‚</textarea>
            </div>
            <hr>
            <div class="input-group">
                <label>ğŸ“· ä¸Šå‚³ Logo / QRcode</label>
                <input type="file" id="qrUpload" accept="image/*" onchange="handleQrUpload(this)">
            </div>
            <div class="input-group">
                <label>â†”ï¸ åœ–ç‰‡ç¸®æ”¾ (æœƒåœ¨æ–‡å­—ä¸‹æ–¹)</label>
                <input type="range" id="qrSize" min="30" max="250" value="80" oninput="applyStyles()">
            </div>
        </div>

        <div id="tab-style" class="tab-content">
            <div class="color-row"><label>æ¨™é¡Œé¡è‰²</label><input type="color" id="cTitle" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>èƒŒæ™¯åº•è‰²</label><input type="color" id="cBg" value="#f7f3ee" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ˆçŸ¥æ–‡å­—é¡è‰²</label><input type="color" id="cNotice" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>âœ¨ é—œéµå­—é¡è‰² [ ]</label><input type="color" id="cHighlight" value="#d44d4d" oninput="applyStyles()"></div>
            <hr>
            <div class="input-group"><label>æ›´æ›å¤§åº•åœ–</label><input type="file" id="bgUpload" accept="image/*" onchange="handleBgUpload(this)"></div>
            <div class="input-group"><label>åº•åœ–é€æ˜åº¦</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0.5" oninput="applyStyles()"></div>
        </div>
    </div>

    <button class="btn-generate" onclick="exportImage()">ğŸ“· ç”Ÿæˆ 16:9 é ç´„åœ–</button>

    <div class="responsive-wrapper">
        <div id="capture-area">
            <div id="bg-image-layer"></div>
            <div class="content-layer">
                <div id="title-month">2026 FEBRUARY SCHEDULE</div>
                <div id="display-studio-name">æ˜•æ¾„ xincheng</div>
                <div class="calendar-grid" id="calendar"></div>
                <div class="footer-wrap">
                    <div id="display-notice" class="footer-notice"></div>
                    <img id="display-qrcode">
                </div>
            </div>
        </div>
    </div>

    <div id="preview-overlay">
        <img id="preview-image" src="">
        <button class="btn-close" onclick="closePreview()">è¿”å›ä¿®æ”¹</button>
    </div>

    <script>
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        let bgBase64 = localStorage.getItem('xinc_bg') || "";
        let qrBase64 = localStorage.getItem('xinc_qr') || "";

        function openTab(evt, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { bgBase64 = e.target.result; localStorage.setItem('xinc_bg', bgBase64); applyStyles(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleQrUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { qrBase64 = e.target.result; localStorage.setItem('xinc_qr', qrBase64); applyStyles(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function applyStyles() {
            const area = document.getElementById('capture-area');
            const bgLayer = document.getElementById('bg-image-layer');
            const qrImg = document.getElementById('display-qrcode');
            const hlColor = document.getElementById('cHighlight').value;
            
            area.style.backgroundColor = document.getElementById('cBg').value;
            bgLayer.style.backgroundImage = bgBase64 ? `url(${bgBase64})` : 'none';
            bgLayer.style.opacity = document.getElementById('bgOpacity').value;

            if (qrBase64) { 
                qrImg.src = qrBase64; 
                qrImg.style.display = 'block'; 
                qrImg.style.width = document.getElementById('qrSize').value + "px";
            }
            
            document.getElementById('title-month').style.color = document.getElementById('cTitle').value;
            
            const noticeEl = document.getElementById('display-notice');
            noticeEl.style.color = document.getElementById('cNotice').value;
            
            let noticeText = document.getElementById('inputNotice').value;
            let formattedText = noticeText.replace(/\[(.*?)\]/g, `<span class="hl-text" style="color:${hlColor}">$1</span>`);
            noticeEl.innerHTML = formattedText;

            const settings = {};
            document.querySelectorAll('input, textarea').forEach(el => { if(el.id && el.type !== 'file') settings[el.id] = el.value; });
            localStorage.setItem('xinc_settings', JSON.stringify(settings));
        }

        function validateAndUpdate() {
            const year = document.getElementById('inputYear').value || 2026;
            const month = document.getElementById('inputMonth').value || 1;
            document.getElementById('title-month').innerText = `${year} ${monthNames[month-1]} SCHEDULE`;
            document.getElementById('display-studio-name').innerText = document.getElementById('inputStudioName').value;
            updateCalendar(year, month);
            applyStyles();
            handleResize();
        }

        function updateCalendar(year, month) {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '<div class="weekday">é€±æ—¥</div><div class="weekday">é€±ä¸€</div><div class="weekday">é€±äºŒ</div><div class="weekday">é€±ä¸‰</div><div class="weekday">é€±å››</div><div class="weekday">é€±äº”</div><div class="weekday">é€±å…­</div>';
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const slots = document.getElementById('timeSlots').value.split(',').map(s => s.trim()).filter(s => s.includes(':'));
            const excludeInput = document.getElementById('excludeSlots').value;

            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div'); div.className = 'day-box'; div.style.visibility = 'hidden';
                calendar.appendChild(div);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const box = document.createElement('div'); box.className = 'day-box';
                box.innerHTML = `<div class="day-num">${i}</div>`;
                slots.forEach(t => {
                    let skip = false;
                    excludeInput.split(',').forEach(rule => {
                        const p = rule.trim().split(' ');
                        if (p.length >= 2 && p[0] === `${month}/${i}`) {
                            p[1].split('-').forEach(h => { if(t.startsWith(h.trim() + ":")) skip = true; });
                        }
                    });
                    if (!skip) {
                        const s = document.createElement('div'); s.className = 'slot'; s.innerText = t;
                        s.onclick = function() { this.classList.toggle('booked'); };
                        box.appendChild(s);
                    }
                });
                calendar.appendChild(box);
            }
        }

        function handleResize() {
            const area = document.getElementById('capture-area');
            const wrapper = document.querySelector('.responsive-wrapper');
            area.style.transform = "none";
            const scale = Math.min(1, (window.innerWidth - 20) / 420);
            area.style.transform = `scale(${scale})`;
            area.style.transformOrigin = "top center";
            wrapper.style.height = (area.getBoundingClientRect().height) + "px";
        }

        function exportImage() {
            const area = document.getElementById('capture-area');
            const oldT = area.style.transform;
            area.style.transform = "none";
            html2canvas(area, { scale: 3, useCORS: true, width: 420, height: 746.66 }).then(canvas => {
                area.style.transform = oldT;
                document.getElementById('preview-image').src = canvas.toDataURL("image/png");
                document.getElementById('preview-overlay').style.display = 'flex';
            });
        }

        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

        window.onload = () => {
            const saved = localStorage.getItem('xinc_settings');
            if (saved) {
                const json = JSON.parse(saved);
                for (let key in json) { if(document.getElementById(key)) document.getElementById(key).value = json[key]; }
            }
            validateAndUpdate();
        };
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>

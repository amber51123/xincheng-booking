<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜•æ¾„ xincheng é ç´„å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-color: #f7f3ee; --accent-color: #8d775f; --text-color: #4a4a4a; }
        body { font-family: "PingFang TC", "Noto Sans TC", sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: var(--text-color); }
        
        .settings-panel { background: #fff; border-radius: 12px; width: 100%; max-width: 420px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; text-align: left; }
        .tab-nav { display: flex; background: #f8f8f8; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: #888; cursor: pointer; font-size: 13px; }
        .tab-btn.active { color: var(--accent-color); background: #fff; border-bottom: 2px solid var(--accent-color); }
        .tab-content { display: none; padding: 15px; max-height: 420px; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .input-group { margin-bottom: 12px; }
        .input-group label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        
        .upload-row { display: flex; gap: 8px; align-items: center; }
        .btn-clear { padding: 8px 12px; background: #ffeded; color: #d9534f; border: 1px solid #d9534f; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; }

        .color-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f9f9f9; }
        .color-row input[type="color"] { width: 40px; height: 28px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; padding: 0; background: none; }
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }

        /* --- 16:9 ç•«å¸ƒ --- */
        .responsive-wrapper { width: 100%; display: flex; justify-content: center; }
        #capture-area { 
            width: 420px; height: 746.66px; 
            background-color: var(--bg-color); 
            padding: 45px 20px 35px 20px;
            display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
            overflow: hidden;
        }

        #bg-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; pointer-events: none; }
        .content-layer { position: relative; z-index: 2; width: 100%; height: 100%; display: flex; flex-direction: column; }

        .header-section { flex-shrink: 0; text-align: center; margin-bottom: 15px; }
        #display-main-title { font-size: 26px; font-weight: bold; text-transform: uppercase; }
        #display-studio-name { letter-spacing: 5px; font-size: 14px; font-weight: bold; margin-top: 5px; }
        
        .calendar-section { flex: 1; display: flex; flex-direction: column; border-top: 1.5px solid rgba(0,0,0,0.1); padding-top: 10px; min-height: 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; gap: 5px; width: 100%; height: 100%; }
        .weekday { font-size: 10px; font-weight: bold; text-align: center; height: 20px; }
        
        .day-box { border-radius: 4px; display: flex; flex-direction: column; align-items: center; padding: 4px 0; }
        .day-num { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
        .slot-container { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 3px; flex: 1; justify-content: center; }
        .slot { font-size: 8.5px; font-weight: bold; padding: 2px 0; border-radius: 2px; width: 90%; text-align: center; border: 0.5px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.8); cursor: pointer; }
        .slot.booked { display: none !important; }

        .slogan-divider { text-align: center; margin: 15px 0; font-size: 12px; letter-spacing: 3px; flex-shrink: 0; }

        .footer-wrap { flex-shrink: 0; border-top: 1.5px solid rgba(0,0,0,0.1); padding-top: 15px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .footer-notice { font-size: 10.5px; font-weight: bold; text-align: left; line-height: 1.6; white-space: pre-wrap; flex: 1; padding-right: 15px; }
        #display-qrcode { object-fit: contain; display: none; }

        .btn-generate { width: 100%; max-width: 420px; padding: 15px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; margin: 10px 0 20px 0; cursor: pointer; }
        #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #preview-image { max-width: 90%; max-height: 85vh; border-radius: 10px; }
        .btn-close { margin-top: 15px; padding: 10px 40px; background: #fff; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="settings-panel">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab(event, 'tab-time')">ğŸ“… æ™‚é–“è¨­å®š</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-content')">âœï¸ å…§å®¹èª¿æ•´</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-style')">ğŸ¨ æ¨£å¼èª¿æ•´</button>
        </div>
        
        <div id="tab-time" class="tab-content active">
            <div style="display:flex; gap:8px">
                <div class="input-group" style="flex:1"><label>å¹´ä»½</label><input type="number" id="inputYear" value="2026" oninput="validateAndUpdate()"></div>
                <div class="input-group" style="flex:1"><label>æœˆä»½</label><input type="number" id="inputMonth" value="2" oninput="validateAndUpdate()"></div>
            </div>
            <div class="input-group"><label>æ¨™æº–æ™‚æ®µ (æœƒè‡ªå‹•å»é‡æ’åº)</label><input type="text" id="timeSlots" value="10:00, 14:00, 19:00" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>ğŸš« å…¬ä¼‘æ—¥ (æ‰‹å‹•ç•™ç™½)</label><input type="text" id="excludeDays" placeholder="ä¾‹å¦‚: 1, 15" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>âŒ å·²é ç´„æ’é™¤ (æ ¼å¼: 5 14:00)</label><textarea id="excludeSlots" style="height: 60px;" oninput="validateAndUpdate()"></textarea></div>
        </div>
        
        <div id="tab-content" class="tab-content">
            <div class="input-group"><label>å·¥ä½œå®¤åç¨±</label><input type="text" id="inputStudioName" value="æ˜•æ¾„ xincheng" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>å¤§æ¨™é¡Œ</label><input type="text" id="inputMainTitle" value="2026 FEBRUARY" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>æ¨™èª</label><input type="text" id="inputSlogan" value="HOT POT THERAPY" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>é ç´„é ˆçŸ¥</label><textarea id="inputNotice" oninput="validateAndUpdate()">âœ¨ é ç´„é ˆçŸ¥
â€¢ æ¡ä¸€å°ä¸€æœå‹™ï¼Œè«‹æå‰é ç´„ã€‚
â€¢ è®Šæ›´é ç´„è«‹æ–¼ã€Œ[24å°æ™‚å‰]ã€å‘ŠçŸ¥ã€‚
â€¢ [é²åˆ°15åˆ†é˜] å°‡è¦–åŒå–æ¶ˆé ç´„ã€‚</textarea></div>
            <hr>
            <div class="input-group">
                <label>ğŸ“· åœ–ç‰‡ä¸Šå‚³ (LOGO/QRcode)</label>
                <div class="upload-row">
                    <input type="file" id="qrUpload" accept="image/*" onchange="handleImageUpload(this, 'qr')">
                    <button class="btn-clear" onclick="clearImage('qr')">åˆªé™¤</button>
                </div>
            </div>
            <div class="input-group"><label>ğŸ åœ–ç‰‡é€æ˜åº¦</label><input type="range" id="qrOpacity" min="0" max="1" step="0.1" value="1" oninput="applyStyles()"></div>
            <div class="input-group"><label>â†”ï¸ åœ–ç‰‡å¤§å°</label><input type="range" id="qrSize" min="30" max="150" value="70" oninput="applyStyles()"></div>
        </div>
        
        <div id="tab-style" class="tab-content">
            <div class="input-group">
                <label>ğŸ–¼ï¸ åº•åœ–ç…§ç‰‡</label>
                <div class="upload-row">
                    <input type="file" id="bgUpload" accept="image/*" onchange="handleImageUpload(this, 'bg')">
                    <button class="btn-clear" onclick="clearImage('bg')">åˆªé™¤</button>
                </div>
            </div>
            <div class="input-group"><label>ğŸ‘» åº•åœ–é€æ˜åº¦</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0.5" oninput="applyStyles()"></div>
            <div class="input-group"><label>ğŸ”² æ—¥æœŸæ ¼å­èƒŒæ™¯é€æ˜åº¦</label><input type="range" id="boxOpacity" min="0" max="1" step="0.1" value="0.4" oninput="applyStyles()"></div>
            <hr>
            <div class="color-row"><label>å¤§æ¨™é¡Œ</label><input type="color" id="cMainTitle" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>å·¥ä½œå®¤åç¨±</label><input type="color" id="cStudio" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ˜ŸæœŸ</label><input type="color" id="cWeekday" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ—¥æœŸæ•¸å­—</label><input type="color" id="cDay" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ™‚æ®µæ–‡å­—</label><input type="color" id="cSlotText" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ¨™èª</label><input type="color" id="cSlogan" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ˆçŸ¥ä¸€èˆ¬æ–‡å­—</label><input type="color" id="cNotice" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>âœ¨é—œéµæ–‡å­— [] </label><input type="color" id="cNoticeHighlight" value="#8d775f" oninput="applyStyles()"></div>
        </div>
    </div>

    <button class="btn-generate" onclick="exportImage()">ğŸ“· ç”Ÿæˆé ç´„åœ–</button>

    <div class="responsive-wrapper">
        <div id="capture-area">
            <div id="bg-image-layer"></div>
            <div class="content-layer">
                <div class="header-section">
                    <div id="display-main-title"></div>
                    <div id="display-studio-name"></div>
                </div>
                <div class="calendar-section">
                    <div class="calendar-grid" id="calendar"></div>
                </div>
                <div class="slogan-divider" id="display-slogan"></div>
                <div class="footer-wrap">
                    <div id="display-notice" class="footer-notice"></div>
                    <img id="display-qrcode">
                </div>
            </div>
        </div>
    </div>

    <div id="preview-overlay">
        <img id="preview-image" src="">
        <button class="btn-close" onclick="closePreview()">è¿”å›ä¿®æ”¹</button>
    </div>

    <script>
        let bgBase64 = localStorage.getItem('xinc_bg') || "";
        let qrBase64 = localStorage.getItem('xinc_qr') || "";

        function openTab(evt, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function handleImageUpload(input, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    if(type === 'bg') { bgBase64 = e.target.result; localStorage.setItem('xinc_bg', bgBase64); }
                    else { qrBase64 = e.target.result; localStorage.setItem('xinc_qr', qrBase64); }
                    applyStyles();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage(type) {
            if(type === 'bg') { bgBase64 = ""; localStorage.removeItem('xinc_bg'); document.getElementById('bgUpload').value = ""; }
            else { qrBase64 = ""; localStorage.removeItem('xinc_qr'); document.getElementById('qrUpload').value = ""; }
            applyStyles();
        }

        function applyStyles() {
            const bgLayer = document.getElementById('bg-image-layer');
            const qrImg = document.getElementById('display-qrcode');
            bgLayer.style.backgroundImage = bgBase64 ? `url(${bgBase64})` : 'none';
            bgLayer.style.opacity = document.getElementById('bgOpacity').value;
            if (qrBase64) { 
                qrImg.src = qrBase64; qrImg.style.display = 'block'; 
                qrImg.style.width = document.getElementById('qrSize').value + "px";
                qrImg.style.opacity = document.getElementById('qrOpacity').value;
            } else { qrImg.style.display = 'none'; }
            document.getElementById('display-main-title').style.color = document.getElementById('cMainTitle').value;
            document.getElementById('display-studio-name').style.color = document.getElementById('cStudio').value;
            document.getElementById('display-slogan').style.color = document.getElementById('cSlogan').value;
            document.querySelectorAll('.weekday').forEach(el => el.style.color = document.getElementById('cWeekday').value);
            document.querySelectorAll('.day-num').forEach(el => el.style.color = document.getElementById('cDay').value);
            document.querySelectorAll('.slot').forEach(el => el.style.color = document.getElementById('cSlotText').value);
            const boxOp = document.getElementById('boxOpacity').value;
            document.querySelectorAll('.day-box').forEach(box => { 
                box.style.backgroundColor = box.classList.contains('is-exclude') ? 'transparent' : `rgba(255,255,255,${boxOp})`; 
            });
            const noticeEl = document.getElementById('display-notice');
            const noticeColor = document.getElementById('cNotice').value;
            const hlColor = document.getElementById('cNoticeHighlight').value;
            noticeEl.style.color = noticeColor;
            noticeEl.innerHTML = document.getElementById('inputNotice').value.replace(/\[(.*?)\]/g, `<span style="color:${hlColor}; font-weight:900;">$1</span>`);
        }

        function updateCalendar(year, month) {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '<div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div><div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>';
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
            
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // --- æ™‚æ®µå»é‡èˆ‡æ’åºè™•ç† ---
            let slots = document.getElementById('timeSlots').value
                .split(/[,ï¼Œ\s]+/)
                .map(s => s.trim())
                .filter(s => s);
            
            // å»é™¤é‡è¤‡å€¼
            slots = [...new Set(slots)];
            
            // æ’åº (ä¾æ“šæ™‚é–“å…ˆå¾Œ)
            slots.sort((a, b) => {
                const [hA, mA] = a.split(':').map(Number);
                const [hB, mB] = b.split(':').map(Number);
                return (hA * 60 + (mA || 0)) - (hB * 60 + (mB || 0));
            });

            const exDays = document.getElementById('excludeDays').value.split(/[,ï¼Œ\s]+/).map(s => parseInt(s.trim()));
            const exRaw = document.getElementById('excludeSlots').value.split('\n').map(s => s.trim());

            for (let i = 0; i < firstDay; i++) { calendar.appendChild(document.createElement('div')); }
            
            for (let i = 1; i <= daysInMonth; i++) {
                const box = document.createElement('div'); box.className = 'day-box';
                box.innerHTML = `<div class="day-num">${i}</div>`;
                
                const currentBoxDate = new Date(year, month - 1, i);
                const isPast = currentBoxDate < today;
                const isExcluded = exDays.includes(i);

                if (isPast || isExcluded) {
                    box.classList.add('is-exclude');
                    box.style.opacity = "0.15"; 
                } else {
                    const sc = document.createElement('div'); sc.className = 'slot-container';
                    slots.forEach(t => {
                        const s = document.createElement('div'); s.className = 'slot'; s.innerText = t;
                        if (exRaw.some(line => line === `${i} ${t}`)) s.classList.add('booked');
                        s.onclick = function() { this.classList.toggle('booked'); };
                        sc.appendChild(s);
                    });
                    box.appendChild(sc);
                }
                calendar.appendChild(box);
            }
            applyStyles();
            handleResize();
        }

        function validateAndUpdate() {
            document.getElementById('display-studio-name').innerText = document.getElementById('inputStudioName').value;
            document.getElementById('display-main-title').innerText = document.getElementById('inputMainTitle').value;
            document.getElementById('display-slogan').innerText = document.getElementById('inputSlogan').value;
            updateCalendar(parseInt(document.getElementById('inputYear').value), parseInt(document.getElementById('inputMonth').value));
        }

        function handleResize() {
            const area = document.getElementById('capture-area');
            area.style.transform = "none";
            const scale = Math.min(1, (window.innerWidth - 20) / 420);
            area.style.transform = `scale(${scale})`;
            area.style.transformOrigin = "top center";
            document.querySelector('.responsive-wrapper').style.height = (area.getBoundingClientRect().height) + "px";
        }

        function exportImage() {
            const area = document.getElementById('capture-area');
            const oldT = area.style.transform;
            area.style.transform = "none";
            html2canvas(area, { scale: 3, useCORS: true, width: 420, height: 746.66 }).then(canvas => {
                area.style.transform = oldT;
                document.getElementById('preview-image').src = canvas.toDataURL("image/png");
                document.getElementById('preview-overlay').style.display = 'flex';
            });
        }

        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }
        window.onload = () => { validateAndUpdate(); };
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜•æ¾„ xincheng é ç´„å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-color: #f7f3ee; --accent-color: #8d775f; --text-color: #4a4a4a; }
        body { font-family: "PingFang TC", "Noto Sans TC", sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: var(--text-color); }
        
        /* è¨­å®šå€å¡Š */
        .settings-panel { background: #fff; border-radius: 12px; width: 100%; max-width: 420px; margin-bottom: 15px; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-nav { display: flex; background: #f8f8f8; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: #888; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .tab-btn.active { color: var(--accent-color); background: #fff; border-bottom: 2px solid var(--accent-color); }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 12px; }
        .color-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        label { font-size: 12px; font-weight: bold; color: var(--accent-color); }
        input[type="color"] { width: 50px; height: 30px; border: none; padding: 0; background: none; cursor: pointer; }
        input[type="text"], input[type="number"], textarea, input[type="range"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

        /* é è¦½èˆ‡ç”Ÿæˆå€åŸŸå®¹å™¨ï¼šä¿®å¾©æº¢å‡ºçš„æ ¸å¿ƒ */
        .responsive-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; overflow: visible; }

        /* é ç´„è¡¨ä¸»é«”ï¼šå–æ¶ˆå›ºå®šé«˜åº¦é™åˆ¶ */
        #capture-area { 
            width: 420px; 
            min-height: 746px; /* è‡³å°‘ç¶­æŒ 16:9 */
            height: auto;      /* è®“å…§å®¹è‡ªå‹•æ’é–‹é«˜åº¦ */
            background-color: var(--bg-color); 
            padding: 45px 25px 50px 25px; /* å¢åŠ åº•éƒ¨å…§è·ç¢ºä¿ä¸è²¼é‚Š */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            box-sizing: border-box; 
            text-align: center; 
            position: relative; 
            overflow: visible; /* ç¢ºä¿å…§å®¹ä¸è¢«è£åˆ‡ */
        }

        #bg-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; pointer-events: none; }
        .content-layer { position: relative; z-index: 1; width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1; }

        .title-wrap { width: 100%; display: flex; justify-content: center; align-items: center; min-height: 40px; margin-bottom: 5px; }
        #title-month { font-size: 26px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-color); white-space: nowrap; }
        #display-studio-name { margin: 0 auto 20px auto; letter-spacing: 4px; font-size: 14px; font-weight: bold; width: 100%; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; border-top: 1.5px solid rgba(141,119,95,0.4); padding-top: 15px; margin-bottom: 25px; }
        .weekday { font-size: 10px; font-weight: bold; padding-bottom: 8px; }
        .day-box { min-height: 85px; border-radius: 6px; background: rgba(255,255,255,0.6); display: flex; flex-direction: column; align-items: center; padding: 4px 1px; }
        .day-num { font-size: 13px; font-weight: bold; margin-bottom: 4px; }
        
        .slot { font-size: 10px; font-weight: bold; background: #fff; margin: 2px 0; padding: 4px 2px; border-radius: 4px; border: 0.5px solid #eee; width: 92%; cursor: pointer; }
        .slot.booked { opacity: 0 !important; }
        
        /* é ˆçŸ¥å€å¡Šå„ªåŒ–ï¼šç¢ºä¿å®ƒä½æ–¼æœ€åº•éƒ¨ä¸¦æ’é–‹å®¹å™¨ */
        .footer-notice { 
            font-size: 12px; 
            font-weight: bold; 
            margin-top: auto; 
            padding-top: 20px; 
            width: 100%; 
            border-top: 1.5px solid rgba(141,119,95,0.2); 
            text-align: left; 
            line-height: 1.7; 
            white-space: pre-wrap;
            box-sizing: border-box;
        }
        
        .btn-generate { width: 100%; max-width: 420px; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; margin-bottom: 20px; cursor: pointer; }

        #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #preview-image { max-width: 90%; max-height: 80vh; border-radius: 10px; object-fit: contain; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .btn-close { margin-top: 15px; padding: 10px 40px; background: #fff; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="settings-panel">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab(event, 'tab-time')">ğŸ“… é ç´„æ™‚é–“</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-content')">âœï¸ å…§å®¹æ–‡å­—</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-style')">ğŸ¨ æ¨£å¼èª¿æ•´</button>
        </div>

        <div id="tab-time" class="tab-content active">
            <div style="display:flex; gap:8px">
                <div class="input-group" style="flex:1"><label>å¹´ä»½</label><input type="number" id="inputYear" value="2026" oninput="validateAndUpdate()"></div>
                <div class="input-group" style="flex:1"><label>æœˆä»½</label><input type="number" id="inputMonth" value="2" min="1" max="12" oninput="validateAndUpdate()"></div>
            </div>
            <div class="input-group"><label>é–‹æ”¾æ™‚æ®µ</label><input type="text" id="timeSlots" value="15:00, 17:00, 19:00" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>æ’é™¤ (ä¾‹: 2/5 17-19)</label><input type="text" id="excludeSlots" placeholder="2/5 17-19" oninput="validateAndUpdate()"></div>
        </div>

        <div id="tab-content" class="tab-content">
            <div class="input-group"><label>å·¥ä½œå®¤åç¨±</label><input type="text" id="inputStudioName" value="æ˜•æ¾„ xincheng" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>é ç´„é ˆçŸ¥</label><textarea id="inputNotice" oninput="validateAndUpdate()">âœ¨ é ç´„é ˆçŸ¥
â€¢ å·¥ä½œå®¤æ¡ä¸€å°ä¸€æœå‹™ï¼Œè«‹å‹™å¿…æå‰é ç´„ã€‚
â€¢ å¦‚éœ€è®Šæ›´æˆ–å–æ¶ˆé ç´„ï¼Œè«‹æ–¼ã€Œ24å°æ™‚å‰ã€å‘ŠçŸ¥ã€‚
â€¢ ç‚ºç¶­è­·æœå‹™å“è³ªï¼Œé²åˆ°è€…æ–½åšæ™‚é–“å°‡ç„¡æ³•é †å»¶ã€‚</textarea></div>
        </div>

        <div id="tab-style" class="tab-content">
            <div class="color-row"><label>æ¨™é¡Œé¡è‰²</label><input type="color" id="cTitle" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>å·¥ä½œå®¤åç¨±é¡è‰²</label><input type="color" id="cStudio" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ˜ŸæœŸé¡è‰²</label><input type="color" id="cWeek" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ—¥æœŸé¡è‰²</label><input type="color" id="cDay" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ç´„é ˆçŸ¥é¡è‰²</label><input type="color" id="cNotice" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>åº•åœ–èƒŒæ™¯è‰²</label><input type="color" id="cBg" value="#f7f3ee" oninput="applyStyles()"></div>
            <hr style="border:0.5px solid #eee; margin:15px 0;">
            <div class="input-group"><label>ä¸Šå‚³åº•åœ–</label><input type="file" id="bgUpload" accept="image/*" onchange="handleBgUpload(this)"></div>
            <div class="input-group"><label>åº•åœ–é€æ˜åº¦</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0.5" oninput="applyStyles()"></div>
        </div>
    </div>

    <button class="btn-generate" onclick="exportImage()">ğŸ“· ç”Ÿæˆå®Œæ•´é ç´„åœ–</button>

    <div class="responsive-wrapper">
        <div id="capture-area">
            <div id="bg-image-layer"></div>
            <div class="content-layer">
                <div class="title-wrap"><div id="title-month">2026 FEBRUARY SCHEDULE</div></div>
                <div id="display-studio-name">æ˜•æ¾„ xincheng</div>
                <div class="calendar-grid" id="calendar">
                    <div class="weekday">é€±æ—¥</div><div class="weekday">é€±ä¸€</div><div class="weekday">é€±äºŒ</div>
                    <div class="weekday">é€±ä¸‰</div><div class="weekday">é€±å››</div><div class="weekday">é€±äº”</div>
                    <div class="weekday">é€±å…­</div>
                </div>
                <div id="display-notice" class="footer-notice"></div>
            </div>
        </div>
    </div>

    <div id="preview-overlay">
        <div style="color:white; margin-bottom:15px; font-weight:bold; text-align:center;">âœ¨ ç”ŸæˆæˆåŠŸï¼<br>è«‹ã€é•·æŒ‰åœ–ç‰‡ã€‘å„²å­˜åˆ°ç›¸ç°¿</div>
        <img id="preview-image" src="">
        <button class="btn-close" onclick="closePreview()">è¿”å›ä¿®æ”¹</button>
    </div>

    <script>
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        let bgBase64 = "";

        function openTab(evt, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { bgBase64 = e.target.result; applyStyles(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function applyStyles() {
            const area = document.getElementById('capture-area');
            const bgLayer = document.getElementById('bg-image-layer');
            area.style.backgroundColor = document.getElementById('cBg').value;
            bgLayer.style.backgroundImage = bgBase64 ? `url(${bgBase64})` : 'none';
            bgLayer.style.opacity = document.getElementById('bgOpacity').value;
            document.getElementById('title-month').style.color = document.getElementById('cTitle').value;
            document.getElementById('display-studio-name').style.color = document.getElementById('cStudio').value;
            document.getElementById('display-notice').style.color = document.getElementById('cNotice').value;
            document.querySelectorAll('.weekday').forEach(el => el.style.color = document.getElementById('cWeek').value);
            document.querySelectorAll('.day-num').forEach(el => el.style.color = document.getElementById('cDay').value);
        }

        function validateAndUpdate() {
            const year = document.getElementById('inputYear').value || 2026;
            const month = document.getElementById('inputMonth').value || 1;
            const titleEl = document.getElementById('title-month');
            titleEl.innerText = `${year} ${monthNames[month-1]} SCHEDULE`;
            document.getElementById('display-studio-name').innerText = document.getElementById('inputStudioName').value;
            document.getElementById('display-notice').innerText = document.getElementById('inputNotice').value;
            
            let fs = 26; titleEl.style.fontSize = fs + "px";
            while (titleEl.scrollWidth > 370 && fs > 12) { fs--; titleEl.style.fontSize = fs + "px"; }
            
            updateCalendar(year, month);
            applyStyles();
            setTimeout(handleResize, 50);
        }

        function updateCalendar(year, month) {
            const calendar = document.getElementById('calendar');
            while (calendar.children.length > 7) calendar.removeChild(calendar.lastChild);
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const slots = document.getElementById('timeSlots').value.split(',').map(s => s.trim()).filter(s => s.includes(':'));
            const excludeInput = document.getElementById('excludeSlots').value;

            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div'); div.className = 'day-box'; div.style.visibility = 'hidden';
                calendar.appendChild(div);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const box = document.createElement('div'); box.className = 'day-box';
                box.innerHTML = `<div class="day-num">${i}</div>`;
                slots.forEach(t => {
                    let skip = false;
                    excludeInput.split(',').forEach(rule => {
                        const p = rule.trim().split(' ');
                        if (p.length >= 2 && p[0] === `${month}/${i}`) {
                            p[1].split('-').forEach(h => { if(t.startsWith(h.trim() + ":")) skip = true; });
                        }
                    });
                    if (!skip) {
                        const s = document.createElement('div'); s.className = 'slot'; s.innerText = t;
                        s.onclick = function() { this.classList.toggle('booked'); };
                        box.appendChild(s);
                    }
                });
                calendar.appendChild(box);
            }
        }

        function handleResize() {
            const area = document.getElementById('capture-area');
            const wrapper = document.querySelector('.responsive-wrapper');
            const winW = window.innerWidth;
            area.style.transform = "none"; 
            if (winW < 440) {
                const scale = (winW - 20) / 420;
                area.style.transform = `scale(${scale})`;
                wrapper.style.height = (area.getBoundingClientRect().height) + "px";
            } else { wrapper.style.height = "auto"; }
        }

        function exportImage() {
            const area = document.getElementById('capture-area');
            const oldT = area.style.transform;
            area.style.transform = "none"; // æˆªåœ–å‰é‚„åŸæ¯”ä¾‹ä»¥ç²å¾—æœ€é«˜ç•«è³ª
            
            // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ªï¼Œç¢ºä¿æŠ“å–åˆ°å®Œæ•´é«˜åº¦
            const fullHeight = area.offsetHeight; 

            html2canvas(area, { 
                scale: 3, 
                useCORS: true,
                backgroundColor: null,
                width: 420,
                height: fullHeight, // ä½¿ç”¨è¨ˆç®—å¾Œçš„å®Œæ•´é«˜åº¦
                windowWidth: 420,
                windowHeight: fullHeight
            }).then(canvas => {
                area.style.transform = oldT;
                document.getElementById('preview-image').src = canvas.toDataURL("image/png");
                document.getElementById('preview-overlay').style.display = 'flex';
                handleResize();
            });
        }

        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }
        window.addEventListener('resize', handleResize);
        window.onload = validateAndUpdate;
    </script>
</body>
</html>

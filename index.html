<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜•æ¾„ xincheng é ç´„å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg-color: #f7f3ee; --accent-color: #8d775f; --text-color: #4a4a4a; }
        body { font-family: "PingFang TC", "Noto Sans TC", sans-serif; background: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: var(--text-color); }
        
        /* è¨­å®šé¢æ¿ */
        .settings-panel { background: #fff; border-radius: 12px; width: 100%; max-width: 420px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; z-index: 100; }
        .tab-nav { display: flex; background: #f8f8f8; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; color: #888; cursor: pointer; font-size: 13px; }
        .tab-btn.active { color: var(--accent-color); background: #fff; border-bottom: 2px solid var(--accent-color); }
        .tab-content { display: none; padding: 15px; max-height: 450px; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .input-group { margin-bottom: 12px; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        input[type="color"] { width: 45px; height: 28px; border: 1px solid #ddd; cursor: pointer; padding: 0; }
        input[type="text"], input[type="number"], textarea, input[type="range"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        .color-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }

        /* é è¦½å€åŸŸ - 16:9 */
        .responsive-wrapper { width: 100%; display: flex; justify-content: center; }
        #capture-area { 
            width: 420px; height: 746.66px; 
            background-color: var(--bg-color); 
            padding: 40px 20px 30px 20px;
            display: flex; flex-direction: column; 
            box-sizing: border-box; position: relative;
            overflow: hidden;
        }

        #bg-image-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; pointer-events: none; }
        .content-layer { position: relative; z-index: 2; width: 100%; height: 100%; display: flex; flex-direction: column; }

        #title-month { font-size: 22px; font-weight: bold; text-transform: uppercase; text-align: center; margin-bottom: 2px; }
        #display-studio-name { text-align: center; margin-bottom: 15px; letter-spacing: 4px; font-size: 13px; font-weight: bold; }
        
        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; width: 100%; 
            border-top: 1.2px solid rgba(0,0,0,0.1); padding-top: 10px;
            flex: 1; min-height: 0;
        }
        .weekday { font-size: 9px; font-weight: bold; padding-bottom: 5px; text-align: center; }
        .day-box { border-radius: 4px; display: flex; flex-direction: column; align-items: center; padding: 3px 0; }
        .day-num { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
        .slot { font-size: 8px; font-weight: bold; margin: 1px 0; padding: 2px 0; border-radius: 2px; width: 90%; text-align: center; border: 0.5px solid rgba(0,0,0,0.05); }
        .slot.booked { opacity: 0 !important; }

        /* åº•éƒ¨å€åŸŸ */
        .footer-wrap { 
            border-top: 1.2px solid rgba(0,0,0,0.1); 
            padding-top: 12px; 
            display: flex; align-items: flex-end; justify-content: space-between;
            width: 100%; position: relative;
        }
        .footer-notice { font-size: 10px; font-weight: bold; text-align: left; line-height: 1.6; white-space: pre-wrap; flex: 1; z-index: 10; padding-right: 10px; }
        #display-qrcode { object-fit: contain; display: none; z-index: 1; }
        .hl-text { font-weight: 900; }

        .btn-generate { width: 100%; max-width: 420px; padding: 16px; background: var(--accent-color); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; margin: 10px 0 20px 0; cursor: pointer; }
        #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #preview-image { max-width: 90%; max-height: 80vh; border-radius: 10px; }
        .btn-close { margin-top: 15px; padding: 10px 40px; background: #fff; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="settings-panel">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab(event, 'tab-time')">ğŸ“… æ™‚é–“è¨­å®š</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-content')">âœï¸ å…§å®¹èª¿æ•´</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-style')">ğŸ¨ æ¨£å¼èª¿æ•´</button>
        </div>

        <div id="tab-time" class="tab-content active">
            <div style="display:flex; gap:8px">
                <div class="input-group" style="flex:1"><label>å¹´ä»½</label><input type="number" id="inputYear" value="2026" oninput="validateAndUpdate()"></div>
                <div class="input-group" style="flex:1"><label>æœˆä»½</label><input type="number" id="inputMonth" value="2" oninput="validateAndUpdate()"></div>
            </div>
            <div class="input-group"><label>æ™‚æ®µ (é€—è™Ÿéš”é–‹)</label><input type="text" id="timeSlots" value="15:00, 17:00, 19:00" oninput="validateAndUpdate()"></div>
            <div class="input-group"><label>æ’é™¤ (2/5 17-19)</label><input type="text" id="excludeSlots" placeholder="2/5 17-19" oninput="validateAndUpdate()"></div>
        </div>

        <div id="tab-content" class="tab-content">
            <div class="input-group"><label>å·¥ä½œå®¤åç¨±</label><input type="text" id="inputStudioName" value="æ˜•æ¾„ xincheng" oninput="validateAndUpdate()"></div>
            <div class="input-group">
                <label>é ˆçŸ¥ ([ ] æ”¹è‰²)</label>
                <textarea id="inputNotice" oninput="validateAndUpdate()">âœ¨ é ç´„é ˆçŸ¥
â€¢ å·¥ä½œå®¤æ¡ä¸€å°ä¸€æœå‹™ï¼Œè«‹æå‰é ç´„ã€‚
â€¢ è®Šæ›´é ç´„è«‹æ–¼ã€Œ[24å°æ™‚å‰]ã€å‘ŠçŸ¥ã€‚
â€¢ [é²åˆ°è€…] æ–½åšæ™‚é–“å°‡ç„¡æ³•é †å»¶ã€‚</textarea>
            </div>
            <hr>
            <div class="input-group"><label>ğŸ“· åœ–ç‰‡ä¸Šå‚³ Logo/QRcode</label><input type="file" id="qrUpload" accept="image/*" onchange="handleQrUpload(this)"></div>
            <div class="input-group"><label>â†”ï¸ åœ–ç‰‡å¤§å°</label><input type="range" id="qrSize" min="30" max="250" value="80" oninput="applyStyles()"></div>
            <div class="input-group"><label>ğŸ‘» åœ–ç‰‡é€æ˜åº¦</label><input type="range" id="qrOpacity" min="0" max="1" step="0.1" value="1" oninput="applyStyles()"></div>
        </div>

        <div id="tab-style" class="tab-content">
            <div class="color-row"><label>æ¨™é¡Œæ–‡å­—</label><input type="color" id="cTitle" value="#8d775f" oninput="applyStyles()"></div>
            <div class="color-row"><label>å·¥ä½œå®¤åç¨±</label><input type="color" id="cStudio" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>åº•åœ–/èƒŒæ™¯åº•è‰²</label><input type="color" id="cBg" value="#f7f3ee" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ˜ŸæœŸ</label><input type="color" id="cWeek" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>æ—¥æœŸ</label><input type="color" id="cDay" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ç´„æ ¼å­èƒŒæ™¯è‰²</label><input type="color" id="cBoxBg" value="#ffffff" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ç´„æ ¼å­æ–‡å­—è‰²</label><input type="color" id="cSlotText" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>é ç´„é ˆçŸ¥é¡è‰²</label><input type="color" id="cNotice" value="#4a4a4a" oninput="applyStyles()"></div>
            <div class="color-row"><label>âœ¨ é—œéµå­—é¡è‰² [ ]</label><input type="color" id="cHighlight" value="#d44d4d" oninput="applyStyles()"></div>
            <hr>
            <div class="input-group"><label>åº•åœ–ç…§ç‰‡æ›´æ›</label><input type="file" id="bgUpload" accept="image/*" onchange="handleBgUpload(this)"></div>
            <div class="input-group"><label>åº•åœ–ç…§ç‰‡é€æ˜åº¦</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0.5" oninput="applyStyles()"></div>
            <div class="input-group"><label>é ç´„æ ¼å­é€æ˜åº¦</label><input type="range" id="boxOpacity" min="0" max="1" step="0.1" value="0.4" oninput="applyStyles()"></div>
        </div>
    </div>

    <button class="btn-generate" onclick="exportImage()">ğŸ“· ç”Ÿæˆé ç´„åœ–</button>

    <div class="responsive-wrapper">
        <div id="capture-area">
            <div id="bg-image-layer"></div>
            <div class="content-layer">
                <div id="title-month">2026 FEBRUARY</div>
                <div id="display-studio-name">æ˜•æ¾„ xincheng</div>
                <div class="calendar-grid" id="calendar"></div>
                <div class="footer-wrap">
                    <div id="display-notice" class="footer-notice"></div>
                    <img id="display-qrcode">
                </div>
            </div>
        </div>
    </div>

    <div id="preview-overlay">
        <div style="color:white; margin-bottom:10px; font-weight:bold;">âœ¨é•·æŒ‰åœ–ç‰‡å„²å­˜</div>
        <img id="preview-image" src="">
        <button class="btn-close" onclick="closePreview()">è¿”å›ä¿®æ”¹</button>
    </div>

    <script>
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        let bgBase64 = localStorage.getItem('xinc_bg') || "";
        let qrBase64 = localStorage.getItem('xinc_qr') || "";

        function openTab(evt, id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { bgBase64 = e.target.result; localStorage.setItem('xinc_bg', bgBase64); applyStyles(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleQrUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { qrBase64 = e.target.result; localStorage.setItem('xinc_qr', qrBase64); applyStyles(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function applyStyles() {
            const area = document.getElementById('capture-area');
            const bgLayer = document.getElementById('bg-image-layer');
            const qrImg = document.getElementById('display-qrcode');
            
            // åŸºç¤èƒŒæ™¯
            area.style.backgroundColor = document.getElementById('cBg').value;
            bgLayer.style.backgroundImage = bgBase64 ? `url(${bgBase64})` : 'none';
            bgLayer.style.opacity = document.getElementById('bgOpacity').value;

            // Logo
            if (qrBase64) { 
                qrImg.src = qrBase64; qrImg.style.display = 'block'; 
                qrImg.style.width = document.getElementById('qrSize').value + "px";
                qrImg.style.opacity = document.getElementById('qrOpacity').value;
            }
            
            // æ–‡å­—é¡è‰²
            document.getElementById('title-month').style.color = document.getElementById('cTitle').value;
            document.getElementById('display-studio-name').style.color = document.getElementById('cStudio').value;
            
            // æ˜ŸæœŸèˆ‡æ—¥æœŸ
            document.querySelectorAll('.weekday').forEach(el => el.style.color = document.getElementById('cWeek').value);
            document.querySelectorAll('.day-num').forEach(el => el.style.color = document.getElementById('cDay').value);

            // æ ¼å­èˆ‡æ™‚æ®µ
            const boxColor = document.getElementById('cBoxBg').value;
            const boxOp = document.getElementById('boxOpacity').value;
            const slotTextCol = document.getElementById('cSlotText').value;
            
            // è½‰æ› Hex åˆ° RGB æ‡‰ç”¨é€æ˜åº¦
            const r = parseInt(boxColor.slice(1,3), 16), g = parseInt(boxColor.slice(3,5), 16), b = parseInt(boxColor.slice(5,7), 16);
            document.querySelectorAll('.day-box').forEach(box => {
                box.style.backgroundColor = `rgba(${r},${g},${b},${boxOp})`;
            });
            document.querySelectorAll('.slot').forEach(slot => {
                slot.style.color = slotTextCol;
                slot.style.backgroundColor = `rgba(255,255,255,0.7)`; // æ™‚æ®µèƒŒæ™¯å›ºå®šå¾®é€ç™½æå‡å¯è®€æ€§
            });

            // é ˆçŸ¥
            const noticeEl = document.getElementById('display-notice');
            noticeEl.style.color = document.getElementById('cNotice').value;
            const hlColor = document.getElementById('cHighlight').value;
            let noticeText = document.getElementById('inputNotice').value;
            noticeEl.innerHTML = noticeText.replace(/\[(.*?)\]/g, `<span class="hl-text" style="color:${hlColor}">$1</span>`);

            const settings = {};
            document.querySelectorAll('input, textarea').forEach(el => { if(el.id && el.type !== 'file') settings[el.id] = el.value; });
            localStorage.setItem('xinc_settings', JSON.stringify(settings));
        }

        function validateAndUpdate() {
            const year = document.getElementById('inputYear').value || 2026;
            const month = document.getElementById('inputMonth').value || 1;
            document.getElementById('title-month').innerText = `${year} ${monthNames[month-1]}`;
            document.getElementById('display-studio-name').innerText = document.getElementById('inputStudioName').value;
            updateCalendar(year, month);
            applyStyles();
            handleResize();
        }

        function updateCalendar(year, month) {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '<div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div><div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>';
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const slots = document.getElementById('timeSlots').value.split(',').map(s => s.trim()).filter(s => s.includes(':'));
            const excludeInput = document.getElementById('excludeSlots').value;

            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div'); div.className = 'day-box'; div.style.visibility = 'hidden';
                calendar.appendChild(div);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const box = document.createElement('div'); box.className = 'day-box';
                box.innerHTML = `<div class="day-num">${i}</div>`;
                slots.forEach(t => {
                    let skip = false;
                    excludeInput.split(',').forEach(rule => {
                        const p = rule.trim().split(' ');
                        if (p.length >= 2 && p[0] === `${month}/${i}`) {
                            p[1].split('-').forEach(h => { if(t.startsWith(h.trim() + ":")) skip = true; });
                        }
                    });
                    if (!skip) {
                        const s = document.createElement('div'); s.className = 'slot'; s.innerText = t;
                        s.onclick = function() { this.classList.toggle('booked'); };
                        box.appendChild(s);
                    }
                });
                calendar.appendChild(box);
            }
        }

        function handleResize() {
            const area = document.getElementById('capture-area');
            const wrapper = document.querySelector('.responsive-wrapper');
            area.style.transform = "none";
            const scale = Math.min(1, (window.innerWidth - 20) / 420);
            area.style.transform = `scale(${scale})`;
            area.style.transformOrigin = "top center";
            wrapper.style.height = (area.getBoundingClientRect().height) + "px";
        }

        function exportImage() {
            const area = document.getElementById('capture-area');
            const oldT = area.style.transform;
            area.style.transform = "none";
            html2canvas(area, { scale: 3, useCORS: true, width: 420, height: 746.66 }).then(canvas => {
                area.style.transform = oldT;
                document.getElementById('preview-image').src = canvas.toDataURL("image/png");
                document.getElementById('preview-overlay').style.display = 'flex';
            });
        }

        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

        window.onload = () => {
            const saved = localStorage.getItem('xinc_settings');
            if (saved) {
                const json = JSON.parse(saved);
                for (let key in json) { if(document.getElementById(key)) document.getElementById(key).value = json[key]; }
            }
            validateAndUpdate();
        };
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>
